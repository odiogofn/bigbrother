<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Grande Irmão - Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="flex flex-col md:flex-row min-h-screen">

  <!-- SIDEBAR -->
  <aside class="bg-gradient-to-b from-blue-600 to-blue-800 text-white w-full md:w-64 p-6 flex flex-col">
    <h1 class="text-3xl font-bold mb-10 text-center">Admin</h1>
    <nav class="flex flex-col gap-4">
      <button id="navParticipantes" class="py-2 px-4 rounded-xl bg-blue-500 hover:bg-blue-600 transition">Participantes</button>
      <button id="navResultados" class="py-2 px-4 rounded-xl bg-blue-500 hover:bg-blue-600 transition">Resultados</button>
    </nav>
  </aside>

  <!-- CONTEÚDO -->
  <main class="flex-1 p-6">

    <!-- LOGIN -->
    <div id="loginDiv" class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl mt-20">
      <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">Login Admin</h2>
      <input type="text" id="login" placeholder="Login" class="border rounded-xl px-4 py-3 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <input type="password" id="senha" placeholder="Senha" class="border rounded-xl px-4 py-3 w-full mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl transition">Entrar</button>
      <p id="msgLogin" class="mt-3 text-center"></p>
    </div>

    <!-- DASHBOARD -->
    <div id="adminContent" class="hidden space-y-6 mt-8">

      <!-- CADASTRO DE PARTICIPANTES -->
      <div id="cardParticipantes" class="hidden bg-white p-6 rounded-2xl shadow hover:shadow-2xl transition">
        <h2 class="text-xl font-semibold mb-4">Cadastrar Participante</h2>
        <div class="flex gap-3 flex-wrap">
          <input type="text" id="novoParticipante" placeholder="Nome do participante" class="flex-1 border rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
          <button id="adicionarParticipante" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-2 rounded-xl transition">Adicionar</button>
        </div>
        <p id="msgParticipante" class="mt-3 text-center font-medium"></p>
      </div>

      <!-- LANÇAR RESULTADOS -->
      <div id="cardResultados" class="hidden bg-white p-6 rounded-2xl shadow hover:shadow-2xl transition">
        <h2 class="text-xl font-semibold mb-4">Lançar Resultado da Semana</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <div class="mb-3">
            <label class="block font-medium mb-1">Semana</label>
            <input type="number" id="semana" class="border rounded-xl px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block font-medium mb-1">Líder</label>
            <select id="lider" multiple class="border rounded-xl px-4 py-2 w-full"></select>
          </div>

          <div>
            <label class="block font-medium mb-1">Anjo</label>
            <select id="anjo" multiple class="border rounded-xl px-4 py-2 w-full"></select>
          </div>

          <div>
            <label class="block font-medium mb-1">Emparedados</label>
            <select id="emparedados" multiple class="border rounded-xl px-4 py-2 w-full"></select>
          </div>

          <div>
            <label class="block font-medium mb-1">Eliminados</label>
            <select id="eliminados" multiple class="border rounded-xl px-4 py-2 w-full"></select>
          </div>

          <div>
            <label class="block font-medium mb-1">Bate-Volta</label>
            <select id="bateVolta" multiple class="border rounded-xl px-4 py-2 w-full"></select>
          </div>

        </div>
        <button id="salvar" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl transition">Salvar Resultado</button>
        <p id="msg" class="mt-3 text-center font-medium"></p>
      </div>

    </div>
  </main>
</div>

<script>
  // Inicializa Supabase antes de usar
  const supabaseUrl = "https://biojnilbgzozmynemtra.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb2puaWxiZ3pvem15bmVtdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDM5MzEsImV4cCI6MjA3MjIxOTkzMX0.F8MyL33SdQ7RViOF5RWgoZh8vC6hsyNqmqUXmRcNPDM";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  document.addEventListener("DOMContentLoaded", () => {
    console.log("Script carregado!");

    // LOGIN ADMIN
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const login = document.getElementById("login").value.trim();
      const senha = document.getElementById("senha").value.trim();
      const msg = document.getElementById("msgLogin");

      console.log("Tentativa de login:", login, senha);

      if(login === "admin" && senha === "admin"){
        document.getElementById("loginDiv").classList.add("hidden");
        document.getElementById("adminContent").classList.remove("hidden");
        document.getElementById("cardParticipantes").classList.remove("hidden");
        document.getElementById("cardResultados").classList.add("hidden");
        preencherSelects();
      } else {
        msg.textContent = "Login ou senha incorretos";
        msg.className = "mt-3 text-red-600 text-center font-medium";
      }
    });

    // Alternar abas
    document.getElementById("navParticipantes").addEventListener("click", () => {
      document.getElementById("cardParticipantes").classList.remove("hidden");
      document.getElementById("cardResultados").classList.add("hidden");
    });

    document.getElementById("navResultados").addEventListener("click", () => {
      document.getElementById("cardParticipantes").classList.add("hidden");
      document.getElementById("cardResultados").classList.remove("hidden");
    });

    // CARREGAR PARTICIPANTES
    async function carregarParticipantes() {
      const { data, error } = await supabase
        .from("participantes")
        .select("nome")
        .eq("ativo", true)
        .order("nome");
      if(error){ alert("Erro: " + error.message); return []; }
      return data.map(p => p.nome);
    }

    // PREENCHER SELECTS
    async function preencherSelects() {
      const participantes = await carregarParticipantes();
      ["lider","anjo","emparedados","eliminados","bateVolta"].forEach(id => {
        const sel = document.getElementById(id);
        sel.innerHTML = "";
        participantes.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p;
          opt.textContent = p;
          sel.appendChild(opt);
        });
      });
    }

    // ADICIONAR PARTICIPANTE
    document.getElementById("adicionarParticipante").addEventListener("click", async () => {
      const nome = document.getElementById("novoParticipante").value.trim();
      if(!nome){ alert("Digite o nome"); return; }

      const { data, error } = await supabase
        .from("participantes")
        .insert([{ nome, ativo: true, criado_em: new Date().toISOString() }]);

      const msg = document.getElementById("msgParticipante");
      if(error){
        msg.textContent = "Erro: " + error.message;
        msg.className = "mt-3 text-red-600 text-center font-medium";
      } else {
        msg.textContent = "Participante adicionado!";
        msg.className = "mt-3 text-green-600 text-center font-medium";
        document.getElementById("novoParticipante").value = "";
        preencherSelects();
      }
    });

    // SALVAR RESULTADOS
    document.getElementById("salvar").addEventListener("click", async () => {
      const semana = parseInt(document.getElementById("semana").value);
      if(!semana){ alert("Informe a semana"); return; }

      const payload = {
        semana,
        lider: Array.from(document.getElementById("lider").selectedOptions).map(o=>o.value),
        anjo: Array.from(document.getElementById("anjo").selectedOptions).map(o=>o.value),
        emparedados: Array.from(document.getElementById("emparedados").selectedOptions).map(o=>o.value),
        eliminados: Array.from(document.getElementById("eliminados").selectedOptions).map(o=>o.value),
        bate_volta: Array.from(document.getElementById("bateVolta").selectedOptions).map(o=>o.value),
        criado_em: new Date().toISOString()
      };

      const { data, error } = await supabase.from("resultados").insert([payload]);
      const msg = document.getElementById("msg");
      if(error){
        msg.textContent = "Erro ao salvar: " + error.message;
        msg.className = "mt-3 text-red-600 text-center font-medium";
      } else {
        msg.textContent = "Resultado salvo com sucesso!";
        msg.className = "mt-3 text-green-600 text-center font-medium";
        document.getElementById("semana").value = "";
        preencherSelects();
      }
    });

  });
</script>
</body>
</html>
