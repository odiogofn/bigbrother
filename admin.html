<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Admin - Gigant Brother</title>
  <script type="module" src="supabase.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-5xl mx-auto py-8">
    <h1 class="text-3xl font-bold text-center mb-6">Painel Administrativo - Gigant Brother</h1>

    <!-- Abas -->
    <div class="flex justify-center space-x-4 mb-6">
      <button onclick="abrirAba('participantes')" class="px-4 py-2 bg-blue-500 text-white rounded">Participantes</button>
      <button onclick="abrirAba('palpiteiros')" class="px-4 py-2 bg-blue-500 text-white rounded">Palpiteiros</button>
      <button onclick="abrirAba('gabarito')" class="px-4 py-2 bg-blue-500 text-white rounded">Gabarito</button>
      <button onclick="abrirAba('pontuacao')" class="px-4 py-2 bg-blue-500 text-white rounded">Pontuação</button>
    </div>

    <!-- Participantes -->
    <div id="aba-participantes" class="aba hidden bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">Gerenciar Participantes</h2>
      <form id="form-participante" class="flex space-x-2 mb-4">
        <input type="text" id="nome-participante" placeholder="Nome" class="flex-1 p-2 border rounded">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Adicionar</button>
      </form>
      <ul id="lista-participantes" class="space-y-2 text-gray-700"></ul>
    </div>

    <!-- Palpiteiros -->
    <div id="aba-palpiteiros" class="aba hidden bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">Gerenciar Palpiteiros</h2>
      <form id="form-palpiteiro" class="grid grid-cols-2 gap-2 mb-4">
        <input type="text" id="nome-palpiteiro" placeholder="Nome" class="p-2 border rounded">
        <input type="date" id="nascimento-palpiteiro" class="p-2 border rounded">
        <button type="submit" class="col-span-2 bg-green-600 text-white px-4 py-2 rounded">Adicionar</button>
      </form>
      <ul id="lista-palpiteiros" class="space-y-2 text-gray-700"></ul>
    </div>

    <!-- Gabarito -->
    <div id="aba-gabarito" class="aba hidden bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">Cadastrar Gabarito</h2>
      <form id="form-gabarito" class="space-y-2 mb-4">
        <label>Rodada: <input type="number" id="rodada" class="p-2 border rounded w-24"></label>

        <div>
          <label>Líder(es):</label>
          <select multiple id="lider" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label>Anjo(s):</label>
          <select multiple id="anjo" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label>Imune(s):</label>
          <select multiple id="imune" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label>Emparedado(s):</label>
          <select multiple id="emparedado" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label>Bate e Volta (vencedores):</label>
          <select multiple id="bate_volta" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label>Eliminado(s):</label>
          <select multiple id="eliminado" class="w-full p-2 border rounded"></select>
        </div>

        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Salvar Gabarito</button>
      </form>
      <ul id="lista-gabaritos" class="space-y-2 text-gray-700"></ul>
    </div>

    <!-- Pontuação -->
    <div id="aba-pontuacao" class="aba hidden bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">Regras de Pontuação</h2>
      <form id="form-pontuacao" class="grid grid-cols-2 gap-2 mb-4">
        <input type="number" id="pontos-lider" placeholder="Pontos Líder" class="p-2 border rounded">
        <input type="number" id="pontos-anjo" placeholder="Pontos Anjo" class="p-2 border rounded">
        <input type="number" id="pontos-imune" placeholder="Pontos Imune" class="p-2 border rounded">
        <input type="number" id="pontos-emparedado" placeholder="Pontos Emparedado" class="p-2 border rounded">
        <input type="number" id="pontos-bate-volta" placeholder="Pontos Bate e Volta" class="p-2 border rounded">
        <input type="number" id="pontos-eliminado" placeholder="Pontos Eliminado" class="p-2 border rounded">
        <button type="submit" class="col-span-2 bg-green-600 text-white px-4 py-2 rounded">Salvar</button>
      </form>
      <div id="pontuacao-atual" class="text-gray-700"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./supabase.js";

    // Controle de abas
    window.abrirAba = (id) => {
      document.querySelectorAll(".aba").forEach(el => el.classList.add("hidden"));
      document.getElementById("aba-" + id).classList.remove("hidden");
    };

    abrirAba("participantes"); // padrão

    // === Participantes ===
    const formParticipante = document.getElementById("form-participante");
    const listaParticipantes = document.getElementById("lista-participantes");

    async function carregarParticipantes() {
      listaParticipantes.innerHTML = "";
      let { data } = await supabase.from("participantes").select("*");
      data.forEach(p => {
        let li = document.createElement("li");
        li.className = "flex justify-between items-center border p-2 rounded";
        li.innerHTML = `${p.nome} <button onclick="removerParticipante(${p.id})" class="text-red-500">Remover</button>`;
        listaParticipantes.appendChild(li);
      });

      // Popular selects do gabarito
      ["lider","anjo","imune","emparedado","bate_volta","eliminado"].forEach(campo=>{
        let select = document.getElementById(campo);
        if(select){
          select.innerHTML = "";
          data.forEach(p=>{
            let opt = document.createElement("option");
            opt.value = p.nome;
            opt.textContent = p.nome;
            select.appendChild(opt);
          });
        }
      });
    }

    formParticipante.addEventListener("submit", async (e)=>{
      e.preventDefault();
      let nome = document.getElementById("nome-participante").value;
      if(!nome) return;
      await supabase.from("participantes").insert([{ nome }]);
      formParticipante.reset();
      carregarParticipantes();
    });

    window.removerParticipante = async (id)=>{
      await supabase.from("participantes").delete().eq("id",id);
      carregarParticipantes();
    };

    carregarParticipantes();

    // === Palpiteiros ===
    const formPalpiteiro = document.getElementById("form-palpiteiro");
    const listaPalpiteiros = document.getElementById("lista-palpiteiros");

    async function carregarPalpiteiros() {
      listaPalpiteiros.innerHTML = "";
      let { data } = await supabase.from("palpiteiros").select("*");
      data.forEach(p => {
        let li = document.createElement("li");
        li.className = "flex justify-between items-center border p-2 rounded";
        li.innerHTML = `${p.nome} (${p.nascimento}) <button onclick="removerPalpiteiro(${p.id})" class="text-red-500">Remover</button>`;
        listaPalpiteiros.appendChild(li);
      });
    }

    formPalpiteiro.addEventListener("submit", async (e)=>{
      e.preventDefault();
      let nome = document.getElementById("nome-palpiteiro").value;
      let nascimento = document.getElementById("nascimento-palpiteiro").value;
      if(!nome || !nascimento) return;
      await supabase.from("palpiteiros").insert([{ nome, nascimento }]);
      formPalpiteiro.reset();
      carregarPalpiteiros();
    });

    window.removerPalpiteiro = async (id)=>{
      await supabase.from("palpiteiros").delete().eq("id",id);
      carregarPalpiteiros();
    };

    carregarPalpiteiros();

    // === Gabarito ===
    const formGabarito = document.getElementById("form-gabarito");
    const listaGabaritos = document.getElementById("lista-gabaritos");

    async function carregarGabaritos() {
      listaGabaritos.innerHTML = "";
      let { data } = await supabase.from("gabaritos").select("*").order("rodada",{ascending:true});
      data.forEach(g => {
        let li = document.createElement("li");
        li.className = "border p-2 rounded";
        li.innerHTML = `<b>Rodada ${g.rodada}</b> - Líder: ${g.lider?.join(", ")} | Anjo: ${g.anjo?.join(", ")} | Imune: ${g.imune?.join(", ")} | Emparedado: ${g.emparedado?.join(", ")} | Bate e Volta: ${g.bate_volta?.join(", ")} | Eliminado: ${g.eliminado?.join(", ")}`;
        listaGabaritos.appendChild(li);
      });
    }

    formGabarito.addEventListener("submit", async (e)=>{
      e.preventDefault();
      let rodada = parseInt(document.getElementById("rodada").value);
      let campos = ["lider","anjo","imune","emparedado","bate_volta","eliminado"];
      let obj = { rodada };
      campos.forEach(campo=>{
        let select = document.getElementById(campo);
        obj[campo] = Array.from(select.selectedOptions).map(o=>o.value);
      });
      await supabase.from("gabaritos").insert([obj]);
      formGabarito.reset();
      carregarGabaritos();
    });

    carregarGabaritos();

    // === Pontuação ===
    const formPontuacao = document.getElementById("form-pontuacao");
    const divPontuacao = document.getElementById("pontuacao-atual");

    async function carregarPontuacao() {
      divPontuacao.innerHTML = "";
      let { data } = await supabase.from("pontuacao").select("*").single();
      if(data){
        divPontuacao.innerHTML = `
          <p><b>Líder:</b> ${data.lider} | <b>Anjo:</b> ${data.anjo} | <b>Imune:</b> ${data.imune} | 
          <b>Emparedado:</b> ${data.emparedado} | <b>Bate Volta:</b> ${data.bate_volta} | <b>Eliminado:</b> ${data.eliminado}</p>
        `;
      }
    }

    formPontuacao.addEventListener("submit", async (e)=>{
      e.preventDefault();
      let obj = {
        lider: parseInt(document.getElementById("pontos-lider").value),
        anjo: parseInt(document.getElementById("pontos-anjo").value),
        imune: parseInt(document.getElementById("pontos-imune").value),
        emparedado: parseInt(document.getElementById("pontos-emparedado").value),
        bate_volta: parseInt(document.getElementById("pontos-bate-volta").value),
        eliminado: parseInt(document.getElementById("pontos-eliminado").value),
      };
      await supabase.from("pontuacao").delete().neq("id",0); // reset
      await supabase.from("pontuacao").insert([obj]);
      formPontuacao.reset();
      carregarPontuacao();
    });

    carregarPontuacao();
  </script>
</body>
</html>