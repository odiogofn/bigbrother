<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ranking e Estat√≠sticas - Jogo Grande Irm√£o</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 0; }
    header { background: #4a76a8; color: white; padding: 20px; text-align: center; }
    main { max-width: 1000px; margin: 20px auto; background: white; padding: 20px;
           border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label, select { font-size: 16px; margin-right: 10px; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    canvas { margin-top: 30px; max-width: 100%; }
    .filtros { margin-bottom: 20px; }
  </style>
</head>
<body>
<header>
  <h1>Ranking e Estat√≠sticas</h1>
</header>
<main>
  <div class="filtros">
    <label for="semana-filtro">Filtrar por semana:</label>
    <select id="semana-filtro" onchange="carregarRanking()">
      <option value="0">Todas</option>
      <option value="1">Semana 1</option>
      <option value="2">Semana 2</option>
      <option value="3">Semana 3</option>
      <option value="4">Semana 4</option>
    </select>

    <label for="palpiteiro-filtro">Filtrar por palpiteiro:</label>
    <select id="palpiteiro-filtro" onchange="carregarRanking()">
      <option value="0">Todos</option>
    </select>
  </div>

  <h2>Ranking</h2>
  <table id="ranking-table">
    <thead>
      <tr>
        <th>Posi√ß√£o</th>
        <th>Palpiteiro</th>
        <th>Pontua√ß√£o</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Evolu√ß√£o de Pontua√ß√£o (Semana x Palpiteiro)</h2>
  <canvas id="graficoRanking"></canvas>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // üîπ Exemplo de dados (substituir pelo Supabase depois)
  const dados = {
    Ana:   {1:3, 2:4, 3:4, 4:4},
    Pedro: {1:4, 2:3, 3:3, 4:2},
    Maria: {1:2, 2:3, 3:2, 4:3}
  };

  // Preenche o filtro de palpiteiro
  function preencherFiltroPalpiteiro() {
    const select = document.getElementById('palpiteiro-filtro');
    Object.keys(dados).forEach(nome => {
      const opt = document.createElement('option');
      opt.value = nome;
      opt.textContent = nome;
      select.appendChild(opt);
    });
  }

  function carregarRanking() {
    const semanaFiltro = document.getElementById('semana-filtro').value;
    const palpiteiroFiltro = document.getElementById('palpiteiro-filtro').value;

    // Monta array com pontua√ß√£o
    const ranking = [];
    Object.entries(dados).forEach(([nome, semanas]) => {
      let pontos = 0;

      if (semanaFiltro == 0) {
        pontos = Object.values(semanas).reduce((a,b)=>a+b,0);
      } else {
        pontos = semanas[semanaFiltro] || 0;
      }

      ranking.push({nome, pontos});
    });

    // Aplica filtro por palpiteiro
    let rankingFiltrado = ranking;
    if (palpiteiroFiltro !== "0") {
      rankingFiltrado = ranking.filter(p => p.nome === palpiteiroFiltro);
    }

    // Ordena por pontos
    rankingFiltrado.sort((a,b) => b.pontos - a.pontos);

    // Preenche tabela
    const tbody = document.getElementById('ranking-table').querySelector('tbody');
    tbody.innerHTML = '';
    rankingFiltrado.forEach((p, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${index+1}</td><td>${p.nome}</td><td>${p.pontos}</td>`;
      tbody.appendChild(tr);
    });

    carregarGrafico(semanaFiltro, palpiteiroFiltro);
  }

  function carregarGrafico(semanaFiltro, palpiteiroFiltro) {
    const ctx = document.getElementById('graficoRanking').getContext('2d');
    const labels = ['Semana 1','Semana 2','Semana 3','Semana 4'];

    // Monta datasets filtrados
    let datasets = [];
    Object.entries(dados).forEach(([nome, semanas]) => {
      if (palpiteiroFiltro !== "0" && palpiteiroFiltro !== nome) return;

      let pontos = Object.values(semanas);
      if (semanaFiltro != 0) {
        // mostra s√≥ a semana escolhida
        pontos = labels.map((_, i) => i+1 == semanaFiltro ? semanas[semanaFiltro] : null);
      }

      datasets.push({
        label: nome,
        data: pontos,
        borderColor: gerarCor(nome),
        fill: false
      });
    });

    if (window.graficoInstance) window.graficoInstance.destroy();

    window.graficoInstance = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'Evolu√ß√£o de Pontua√ß√£o' }
        }
      }
    });
  }

  // Gera cor diferente por nome
  function gerarCor(nome) {
    const cores = {
      Ana: 'rgba(75,192,192,1)',
      Pedro: 'rgba(255,99,132,1)',
      Maria: 'rgba(54,162,235,1)'
    };
    return cores[nome] || 'rgba(100,100,100,1)';
  }

  // Inicializa√ß√£o
  preencherFiltroPalpiteiro();
  carregarRanking();
</script>
</body>
</html>
