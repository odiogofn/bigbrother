<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Área do Jogador</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Área do Jogador</h1>

    <!-- login -->
    <div id="loginBox" class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 class="font-semibold mb-3">Login</h2>
      <input id="loginNome" placeholder="Nome" class="w-full px-3 py-2 border rounded mb-3" />
      <input id="loginDt" type="date" class="w-full px-3 py-2 border rounded mb-3" />
      <button id="btnLogin" class="bg-indigo-600 text-white px-4 py-2 rounded">Entrar</button>
      <p id="msgLogin" class="mt-3"></p>
    </div>

    <!-- palpites -->
    <div id="palpitesBox" class="hidden bg-white p-6 rounded-xl shadow">
      <h2 class="font-semibold mb-3">Enviar palpites da semana</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label>Semana</label>
          <input id="palSemana" type="number" class="w-full px-3 py-2 border rounded" />
        </div>
        <div>
          <label>Líder (escolha)</label>
          <select id="palLider" class="w-full px-3 py-2 border rounded"></select>
        </div>
        <div>
          <label>Anjo</label>
          <select id="palAnjo" class="w-full px-3 py-2 border rounded"></select>
        </div>
        <div>
          <label>Emparedados (multi)</label>
          <select id="palEmp" multiple class="w-full h-28 px-3 py-2 border rounded"></select>
        </div>
        <div>
          <label>Eliminados (multi)</label>
          <select id="palElim" multiple class="w-full h-28 px-3 py-2 border rounded"></select>
        </div>
        <div>
          <label>Bate-volta</label>
          <select id="palBate" class="w-full px-3 py-2 border rounded"></select>
        </div>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="btnEnviar" class="bg-green-600 text-white px-4 py-2 rounded">Enviar Palpites</button>
        <button id="btnLogout" class="bg-gray-300 px-4 py-2 rounded">Logout</button>
      </div>

      <p id="msgPal" class="mt-3"></p>

      <!-- histórico do jogador -->
      <h3 class="mt-6 font-semibold">Seus palpites anteriores</h3>
      <div id="histPalpites" class="mt-2"></div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://biojnilbgzozmynemtra.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb2puaWxiZ3pvem15bmVtdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDM5MzEsImV4cCI6MjA3MjIxOTkzMX0.F8MyL33SdQ7RViOF5RWgoZh8vC6hsyNqmqUXmRcNPDM";
window.supabase = window.supabase || supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let usuario = null;

document.getElementById('btnLogin').addEventListener('click', async () => {
  const nome = document.getElementById('loginNome').value.trim();
  const dt = document.getElementById('loginDt').value;
  if(!nome || !dt){ alert('Preencha'); return; }
  // busca usuario
  const { data, error } = await window.supabase.from('usuarios').select('*').eq('nome', nome).eq('dt_nascimento', dt).limit(1).maybeSingle();
  if(error){ alert('Erro: '+error.message); return; }
  if(!data){ document.getElementById('msgLogin').textContent = 'Usuário não encontrado. Cadastre-se.'; return; }
  usuario = data;
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('palpitesBox').classList.remove('hidden');
  carregarParticipantesParaPalpites();
  carregarHistorico();
});

document.getElementById('btnLogout').addEventListener('click', ()=>{ usuario=null; document.getElementById('palpitesBox').classList.add('hidden'); document.getElementById('loginBox').classList.remove('hidden'); });

async function carregarParticipantesParaPalpites(){
  const { data, error } = await window.supabase.from('participantes').select('nome').eq('ativo', true).order('nome');
  if(error){ alert(error.message); return; }
  const nomes = data.map(d=>d.nome);
  ['palLider','palAnjo','palBate','palEmp','palElim'].forEach(id=>{
    const sel = document.getElementById(id); sel.innerHTML = '';
    nomes.forEach(n => { const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
  });
}

document.getElementById('btnEnviar').addEventListener('click', async () => {
  if(!usuario){ alert('Faça login'); return; }
  const semana = parseInt(document.getElementById('palSemana').value);
  if(!semana){ alert('Informe semana'); return; }
  const payload = {
    usuario_id: usuario.id,
    semana,
    lider: Array.from(document.getElementById('palLider').selectedOptions).map(o=>o.value),
    anjo: Array.from(document.getElementById('palAnjo').selectedOptions).map(o=>o.value),
    emparedados: Array.from(document.getElementById('palEmp').selectedOptions).map(o=>o.value),
    eliminados: Array.from(document.getElementById('palElim').selectedOptions).map(o=>o.value),
    bate_volta: Array.from(document.getElementById('palBate').selectedOptions).map(o=>o.value),
    criado_em: new Date()
  };
  const { error } = await window.supabase.from('palpites').insert([payload]);
  const msg = document.getElementById('msgPal');
  if(error){ msg.textContent = 'Erro: '+error.message; msg.className='text-red-600'; }
  else{ msg.textContent = 'Palpite enviado!'; msg.className='text-green-600'; carregarHistorico(); }
});

async function carregarHistorico(){
  if(!usuario) return;
  const { data, error } = await window.supabase.from('palpites').select('*').eq('usuario_id', usuario.id).order('semana', {ascending:false});
  const box = document.getElementById('histPalpites'); box.innerHTML = '';
  if(error){ box.textContent = 'Erro'; return; }
  data.forEach(p=>{
    const d = document.createElement('div'); d.className='p-2 border rounded mb-2 bg-white';
    d.innerHTML = `<strong>Semana ${p.semana}</strong><div class="text-sm">Líder: ${(p.lider||[]).join(', ')}</div><div class="text-sm">Emp: ${(p.emparedados||[]).join(', ')}</div>`;
    box.appendChild(d);
  });
}
</script>
</body>
</html>
