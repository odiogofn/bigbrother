<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Resultados (Admin)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <div id="notAuth" class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold">Acesso restrito</h2>
      <p class="mt-2">Esta página só está disponível para o admin. Faça <a href="admin.html" class="text-blue-600 underline">login como admin</a>.</p>
    </div>

    <div id="app" class="hidden bg-white p-6 rounded shadow">
      <h1 class="text-2xl font-bold mb-4">Cadastrar Resultado (Gabarito) — Admin</h1>

      <form id="gabaritoForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label>Semana</label><input id="sem" type="number" class="w-full border rounded px-3 py-2" /></div>
        <div><label>Líder</label><select id="gLider" class="w-full border rounded px-3 py-2"></select></div>
        <div><label>Anjo</label><select id="gAnjo" class="w-full border rounded px-3 py-2"></select></div>
        <div><label>Bate-volta</label><select id="gBate" class="w-full border rounded px-3 py-2"></select></div>
        <div class="md:col-span-2"><label>Emparedados (multi)</label><select id="gEmp" multiple class="w-full h-28 border rounded px-3 py-2"></select></div>
        <div class="md:col-span-2"><label>Eliminados (multi)</label><select id="gElim" multiple class="w-full h-28 border rounded px-3 py-2"></select></div>
        <div class="md:col-span-2 flex justify-end"><button id="saveGabarito" class="bg-purple-600 text-white px-4 py-2 rounded">Salvar</button></div>
      </form>

      <div class="mt-6">
        <h2 class="font-semibold">Gabaritos cadastrados</h2>
        <div id="listaGabaritos" class="mt-3 space-y-2"></div>
      </div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://biojnilbgzozmynemtra.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb2puaWxiZ3pvem15bmVtdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDM5MzEsImV4cCI6MjA3MjIxOTkzMX0.F8MyL33SdQ7RViOF5RWgoZh8vC6hsyNqmqUXmRcNPDM";
const supabase = window.supabase || supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function init(){
  if(localStorage.getItem('isAdmin') !== '1') {
    document.getElementById('notAuth').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
    return;
  }
  document.getElementById('notAuth').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  loadParticipantsToSelects();
  loadGabaritos();
}

async function loadParticipantsToSelects(){
  const { data } = await supabase.from('participantes').select('nome').eq('ativo', true).order('nome');
  const nomes = (data||[]).map(x=>x.nome);
  ['gLider','gAnjo','gBate','gEmp','gElim'].forEach(id=>{
    const sel = document.getElementById(id); sel.innerHTML='';
    nomes.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
  });
}

document.getElementById('saveGabarito').addEventListener('click', async (ev) => {
  ev.preventDefault();
  const semana = parseInt(document.getElementById('sem').value);
  if(!semana) return alert('Informe semana');
  const payload = {
    semana,
    lider: document.getElementById('gLider').value ? [document.getElementById('gLider').value] : [],
    anjo: document.getElementById('gAnjo').value ? [document.getElementById('gAnjo').value] : [],
    bate_volta: document.getElementById('gBate').value ? [document.getElementById('gBate').value] : [],
    emparedados: Array.from(document.getElementById('gEmp').selectedOptions).map(o=>o.value),
    eliminados: Array.from(document.getElementById('gElim').selectedOptions).map(o=>o.value),
    criado_em: new Date()
  };
  const { error } = await supabase.from('resultados').insert([payload]);
  if(error) return alert('Erro: ' + error.message);
  alert('Gabarito salvo');
  loadGabaritos();
});

async function loadGabaritos(){
  const { data } = await supabase.from('resultados').select('*').order('semana', {ascending:false}).limit(100);
  const box = document.getElementById('listaGabaritos'); box.innerHTML = '';
  (data||[]).forEach(r=>{
    const d = document.createElement('div'); d.className='p-3 border rounded bg-white';
    d.innerHTML = `<strong>Semana ${r.semana}</strong><div class="text-sm">Líder: ${(r.lider||[]).join(', ')}</div>
      <div class="text-sm">Anjo: ${(r.anjo||[]).join(', ')}</div>
      <div class="text-sm">Emp: ${(r.emparedados||[]).join(', ')}</div>
      <div class="text-sm">Elim: ${(r.eliminados||[]).join(', ')}</div>`;
    box.appendChild(d);
  });
}

init();
</script>
</body>
</html>
