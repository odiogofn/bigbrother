<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Área do Palpiteiro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="max-w-2xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-center text-green-700 mb-6">Área do Palpiteiro</h1>

    <!-- Login -->
    <div id="loginArea" class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">Identifique-se</h2>
      <form id="formLogin" class="grid grid-cols-2 gap-2">
        <input type="text" id="nomePalpiteiro" placeholder="Nome" class="border px-2 py-1 rounded col-span-2">
        <input type="date" id="nascimentoPalpiteiro" class="border px-2 py-1 rounded col-span-2">
        <button type="submit" class="col-span-2 bg-green-600 text-white px-4 py-2 rounded">Entrar</button>
      </form>
      <p id="loginMsg" class="text-red-600 mt-2 hidden">Palpiteiro não encontrado!</p>
    </div>

    <!-- Área de Palpites -->
    <div id="palpitesArea" class="hidden bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">Enviar Palpite</h2>
      <form id="formPalpite" class="grid grid-cols-2 gap-2">
        <input type="number" id="semana" placeholder="Semana" class="border px-2 py-1 rounded col-span-2">

        <select id="palpiteLider" class="border px-2 py-1 rounded col-span-2"></select>
        <select id="palpiteAnjo" class="border px-2 py-1 rounded col-span-2"></select>
        <select multiple id="palpiteEmp" class="border px-2 py-1 rounded col-span-2"></select>
        <select id="palpiteElim" class="border px-2 py-1 rounded col-span-2"></select>
        <select id="palpiteBV" class="border px-2 py-1 rounded col-span-2"></select>

        <button type="submit" class="col-span-2 bg-green-600 text-white px-4 py-2 rounded">Salvar Palpite</button>
      </form>

      <h3 class="text-lg font-semibold mt-6">Meus Palpites</h3>
      <ul id="listaPalpites" class="mt-2 space-y-2"></ul>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://biojnilbgzozmynemtra.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb2puaWxiZ3pvem15bmVtdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDM5MzEsImV4cCI6MjA3MjIxOTkzMX0.F8MyL33SdQ7RViOF5RWgoZh8vC6hsyNqmqUXmRcNPDM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let palpiteiroAtual = null;

    // Login
    document.getElementById("formLogin").addEventListener("submit", async e => {
      e.preventDefault();
      const nome = document.getElementById("nomePalpiteiro").value.trim();
      const nascimento = document.getElementById("nascimentoPalpiteiro").value;

      const { data } = await supabase.from("palpiteiros").select("*").eq("nome", nome).eq("data_nascimento", nascimento).maybeSingle();

      if (data) {
        palpiteiroAtual = data;
        document.getElementById("loginArea").classList.add("hidden");
        document.getElementById("palpitesArea").classList.remove("hidden");
        carregarParticipantes();
        carregarPalpites();
      } else {
        document.getElementById("loginMsg").classList.remove("hidden");
      }
    });

    // Preencher selects com participantes
    async function carregarParticipantes() {
      const { data } = await supabase.from("participantes").select("*");
      ["palpiteLider", "palpiteAnjo", "palpiteEmp", "palpiteElim", "palpiteBV"].forEach(id=>{
        const sel = document.getElementById(id);
        sel.innerHTML="";
        data?.forEach(p=>{
          const opt=document.createElement("option");
          opt.value=p.nome;
          opt.textContent=p.nome;
          sel.appendChild(opt);
        });
      });
    }

    // Enviar palpite
    document.getElementById("formPalpite").addEventListener("submit", async e => {
      e.preventDefault();
      if(!palpiteiroAtual) return;

      const semana = document.getElementById("semana").value;
      const lider = document.getElementById("palpiteLider").value;
      const anjo = document.getElementById("palpiteAnjo").value;
      const emp = Array.from(document.getElementById("palpiteEmp").selectedOptions).map(o=>o.value);
      const elim = document.getElementById("palpiteElim").value;
      const bv = document.getElementById("palpiteBV").value;

      await supabase.from("palpites").insert({
        semana,
        palpiteiro_id: palpiteiroAtual.id,
        lider, anjo, emparedados: emp, eliminado: elim, bate_volta: bv
      });

      carregarPalpites();
    });

    // Carregar palpites do palpiteiro logado
    async function carregarPalpites(){
      const { data } = await supabase.from("palpites").select("*").eq("palpiteiro_id", palpiteiroAtual.id);
      const lista=document.getElementById("listaPalpites");
      lista.innerHTML="";
      data?.forEach(p=>{
        const li=document.createElement("li");
        li.className="p-2 border rounded";
        li.textContent=`Semana ${p.semana}: Líder=${p.lider}, Anjo=${p.anjo}, Emp=${p.emparedados?.join(",")}, Elim=${p.eliminado}, BV=${p.bate_volta}`;
        lista.appendChild(li);
      });
    }
  </script>
</body>
</html>
