<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Palpiteiro - Gigant Brother</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="supabase.js"></script>
</head>
<body class="bg-gray-100">

  <!-- Login -->
  <div id="login" class="h-screen flex items-center justify-center">
    <div class="bg-white shadow-lg p-8 rounded-lg w-96">
      <h2 class="text-2xl font-bold mb-4 text-blue-700">Login Palpiteiro</h2>
      <input id="nome" type="text" placeholder="Seu nome" class="w-full p-2 border rounded mb-3">
      <button id="btnLogin" class="w-full bg-blue-600 text-white p-2 rounded">Entrar</button>
    </div>
  </div>

  <!-- Área do palpiteiro -->
  <div id="painel" class="hidden p-6">
    <h1 class="text-3xl font-bold text-blue-700 mb-6">Área do Palpiteiro</h1>

    <div class="flex space-x-4 mb-6">
      <button class="aba bg-blue-600 text-white px-4 py-2 rounded" data-aba="palpitar">Palpitar</button>
      <button class="aba bg-blue-600 text-white px-4 py-2 rounded" data-aba="historico">Histórico</button>
      <button class="aba bg-blue-600 text-white px-4 py-2 rounded" data-aba="ranking">Minha Posição</button>
    </div>

    <div id="conteudo"></div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    const loginDiv = document.getElementById("login");
    const painelDiv = document.getElementById("painel");
    const btnLogin = document.getElementById("btnLogin");
    const conteudo = document.getElementById("conteudo");

    let usuario = null;

    btnLogin.onclick = () => {
      const nome = document.getElementById("nome").value.trim();
      if (!nome) return alert("Digite seu nome!");
      usuario = nome;
      loginDiv.classList.add("hidden");
      painelDiv.classList.remove("hidden");
      conteudo.innerHTML = "<p class='text-gray-500'>Selecione uma aba.</p>";
    };

    document.querySelectorAll(".aba").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (btn.dataset.aba === "palpitar") {
          conteudo.innerHTML = `
            <h2 class="text-xl font-bold mb-4">Enviar Palpite</h2>
            <input id="palpite" type="text" placeholder="Digite seu palpite" class="w-full p-2 border rounded mb-3">
            <button id="enviarPalpite" class="bg-green-600 text-white px-4 py-2 rounded">Enviar</button>
          `;
          document.getElementById("enviarPalpite").onclick = async () => {
            const palpite = document.getElementById("palpite").value;
            if (!palpite) return alert("Digite algo!");
            await supabase.from("palpites").insert([{ nome: usuario, palpite }]);
            alert("Palpite registrado!");
          };
        }

        if (btn.dataset.aba === "historico") {
          let { data } = await supabase.from("palpites").select("*").eq("nome", usuario);
          conteudo.innerHTML = `<h2 class="text-xl font-bold mb-4">Histórico de Palpites</h2>
            <ul class="list-disc pl-6">
              ${data.map(p => `<li>${p.palpite}</li>`).join("")}
            </ul>
            <canvas id="grafico" class="mt-6"></canvas>
          `;

          const ctx = document.getElementById("grafico").getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: data.map((_, i) => "Rodada " + (i+1)),
              datasets: [{
                label: "Pontos",
                data: data.map(() => Math.floor(Math.random() * 10)), // MOCK
                borderColor: "blue"
              }]
            }
          });
        }

        if (btn.dataset.aba === "ranking") {
          let { data } = await supabase.rpc("ranking_geral");
          let posicao = data.findIndex(p => p.nome === usuario) + 1;
          conteudo.innerHTML = `
            <h2 class="text-xl font-bold mb-4">Minha Posição</h2>
            <p>Você está em <b>${posicao}º lugar</b> no ranking.</p>
          `;
        }
      });
    });
  </script>
</body>
</html>
