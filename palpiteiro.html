<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gigant Brother - Área do Palpiteiro</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
<script src="supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="max-w-7xl mx-auto p-4">

  <h1 class="text-3xl font-bold text-center mb-6 text-indigo-600">Gigant Brother - Área do Palpiteiro</h1>

  <!-- Login Palpiteiro -->
  <div id="login-section" class="max-w-md mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">Login</h2>
    <form id="login-form" class="space-y-4">
      <input type="text" id="palpiteiro-nome-login" placeholder="Nome" class="w-full p-2 border rounded">
      <input type="date" id="palpiteiro-nascimento-login" placeholder="Data de Nascimento" class="w-full p-2 border rounded">
      <button type="submit" class="w-full bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700">Entrar</button>
      <p id="login-error" class="text-red-500 hidden">Nome ou data de nascimento incorretos.</p>
    </form>
  </div>

  <!-- Área do Palpiteiro -->
  <div id="palpiteiro-dashboard" class="hidden">

    <div class="bg-white p-6 rounded shadow mb-4">
      <h2 class="text-xl font-semibold mb-4">Enviar Palpite</h2>
      <form id="palpite-form" class="space-y-3">

        <input type="number" id="palpite-semana" placeholder="Semana" class="w-32 p-2 border rounded">

        <div>
          <label>Líder(es):</label>
          <select id="palpite-lider" multiple class="w-full border p-2 rounded"></select>
        </div>

        <div>
          <label>Anjo(s):</label>
          <select id="palpite-anjo" multiple class="w-full border p-2 rounded"></select>
        </div>

        <div>
          <label>Imune(s):</label>
          <select id="palpite-imune" multiple class="w-full border p-2 rounded"></select>
        </div>

        <div>
          <label>Emparedado(s):</label>
          <select id="palpite-emparedado" multiple class="w-full border p-2 rounded"></select>
        </div>

        <div>
          <label>Bate-Volta(s):</label>
          <select id="palpite-batevolta" multiple class="w-full border p-2 rounded"></select>
        </div>

        <div>
          <label>Eliminado(s):</label>
          <select id="palpite-eliminado" multiple class="w-full border p-2 rounded"></select>
        </div>

        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Enviar Palpite</button>
      </form>
    </div>

    <!-- Histórico e Pontuação -->
    <div class="bg-white p-6 rounded shadow mb-4">
      <h2 class="text-xl font-semibold mb-4">Histórico de Palpites</h2>
      <div id="historico-palpiteiros"></div>
    </div>

    <!-- Gráfico -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">Evolução de Pontos</h2>
      <canvas id="grafico-evolucao"></canvas>
    </div>

    <!-- Ranking -->
    <div class="bg-white p-6 rounded shadow mt-4">
      <h2 class="text-xl font-semibold mb-4">Ranking Geral</h2>
      <div id="ranking-list"></div>
    </div>

  </div>

</div>

<script>
let palpiteiroAtual = null;

// login palpiteiro
document.getElementById('login-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const nome = document.getElementById('palpiteiro-nome-login').value;
  const nascimento = document.getElementById('palpiteiro-nascimento-login').value;

  const { data, error } = await supabase.from('palpiteiros')
    .select('*')
    .eq('nome', nome)
    .eq('nascimento', nascimento)
    .single();

  if(data){
    palpiteiroAtual = data;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('palpiteiro-dashboard').classList.remove('hidden');
    carregarParticipantes();
    carregarHistorico();
    carregarRanking();
  } else {
    document.getElementById('login-error').classList.remove('hidden');
  }
});

// carregar participantes para selects
async function carregarParticipantes(){
  const { data } = await supabase.from('participantes').select('*');
  const campos = ['lider','anjo','imune','emparedado','batevolta','eliminado'];
  campos.forEach(c=>{
    const sel = document.getElementById('palpite-'+c);
    sel.innerHTML='';
    data.forEach(p=>{
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.nome;
      sel.appendChild(option);
    });
  });
}

// enviar palpite
document.getElementById('palpite-form').addEventListener('submit', async e=>{
  e.preventDefault();
  const semana = parseInt(document.getElementById('palpite-semana').value);
  const palpite = {
    palpiteiro_id: palpiteiroAtual.id,
    semana,
    lider: Array.from(document.getElementById('palpite-lider').selectedOptions).map(o=>parseInt(o.value)),
    anjo: Array.from(document.getElementById('palpite-anjo').selectedOptions).map(o=>parseInt(o.value)),
    imune: Array.from(document.getElementById('palpite-imune').selectedOptions).map(o=>parseInt(o.value)),
    emparedados: Array.from(document.getElementById('palpite-emparedado').selectedOptions).map(o=>parseInt(o.value)),
    bate_volta: Array.from(document.getElementById('palpite-batevolta').selectedOptions).map(o=>parseInt(o.value)),
    eliminados: Array.from(document.getElementById('palpite-eliminado').selectedOptions).map(o=>parseInt(o.value)),
    criado_em: new Date()
  };
  await supabase.from('palpites').insert([palpite]);
  alert('Palpite enviado!');
  document.getElementById('palpite-form').reset();
  carregarHistorico();
  carregarRanking();
});

// histórico
async function carregarHistorico(){
  const { data } = await supabase.from('palpites').select('*')
    .eq('palpiteiro_id', palpiteiroAtual.id)
    .order('semana', { ascending:true });
  const div = document.getElementById('historico-palpiteiros');
  div.innerHTML='';
  data.forEach(p=>{
    const d = document.createElement('div');
    d.className='border-b p-2';
    d.textContent = `Semana ${p.semana}: L: ${p.lider.length}, A: ${p.anjo.length}, I: ${p.imune.length}, E: ${p.emparedados.length}, BV: ${p.bate_volta.length}, EL: ${p.eliminados.length}`;
    div.appendChild(d);
  });

  // gráfico
  const ctx = document.getElementById('grafico-evolucao').getContext('2d');
  const labels = data.map(p=>'Semana '+p.semana);
  const pontos = data.map(p=>p.pontos || 0);
  new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'Pontos',
        data:pontos,
        borderColor:'rgba(99,102,241,1)',
        backgroundColor:'rgba(99,102,241,0.2)',
        tension:0.3
      }]
    },
    options:{responsive:true,plugins:{legend:{display:true}}}
  });
}

// ranking geral
async function carregarRanking(){
  const { data } = await supabase.from('palpiteiros').select('*').order('pontos',{ascending:false});
  const div = document.getElementById('ranking-list');
  div.innerHTML='';
  data.forEach((p,i)=>{
    const d = document.createElement('div');
    d.textContent = `${i+1} - ${p.nome} - ${p.pontos || 0} pts`;
    div.appendChild(d);
  });
}
</script>
</body>
</html>