<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Área do Palpiteiro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">

  <div class="w-full max-w-4xl bg-white shadow-lg rounded-xl p-6 mt-10">
    <h1 class="text-2xl font-bold text-center mb-6">Área do Palpiteiro</h1>

    <!-- Login -->
    <div id="login-container" class="mb-10">
      <h2 class="text-xl font-semibold mb-3">Login</h2>
      <form id="login-form" class="space-y-4">
        <input type="text" id="nome" placeholder="Nome" class="w-full p-2 border rounded" required>
        <input type="date" id="dataNascimento" placeholder="Data de Nascimento" class="w-full p-2 border rounded" required>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Entrar</button>
      </form>
      <p id="login-msg" class="mt-3 text-sm"></p>
    </div>

    <!-- Palpites -->
    <div id="palpite-container" class="hidden">
      <h2 class="text-xl font-semibold mb-3">Registrar Palpites</h2>
      <form id="palpites-form" class="space-y-4">

        <select id="semana" class="w-full p-2 border rounded">
          <option value="">Selecione a semana</option>
          <option value="1">Semana 1</option>
          <option value="2">Semana 2</option>
          <option value="3">Semana 3</option>
          <option value="4">Semana 4</option>
        </select>

        <div>
          <label class="font-semibold">Líder</label>
          <select id="lider" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="font-semibold">Anjo</label>
          <select id="anjo" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="font-semibold">Emparedados</label>
          <select id="emparedados" multiple class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="font-semibold">Bate-Volta</label>
          <select id="batevolta" class="w-full p-2 border rounded"></select>
        </div>
        <div>
          <label class="font-semibold">Eliminado</label>
          <select id="eliminado" multiple class="w-full p-2 border rounded"></select>
        </div>

        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
          Enviar Palpites
        </button>
      </form>
      <p id="palpite-msg" class="mt-3 text-sm"></p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://biojnilbgzozmynemtra.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb2puaWxiZ3pvem15bmVtdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDM5MzEsImV4cCI6MjA3MjIxOTkzMX0.F8MyL33SdQ7RViOF5RWgoZh8vC6hsyNqmqUXmRcNPDM";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let palpiteiroId = null;

    // Login
    const loginForm = document.getElementById("login-form");
    const loginMsg = document.getElementById("login-msg");
    const loginContainer = document.getElementById("login-container");
    const palpiteContainer = document.getElementById("palpite-container");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nome").value;
      const dataNascimento = document.getElementById("dataNascimento").value;

      const { data, error } = await supabase
        .from("palpiteiros")
        .select("*")
        .eq("nome", nome)
        .eq("data_nascimento", dataNascimento)
        .limit(1)
        .single();

      if (error || !data) {
        loginMsg.textContent = "Usuário não encontrado.";
        loginMsg.className = "text-red-500";
      } else {
        palpiteiroId = data.id;
        loginContainer.classList.add("hidden");
        palpiteContainer.classList.remove("hidden");
        carregarParticipantes();
      }
    });

    // Carregar participantes
    async function carregarParticipantes() {
      const { data, error } = await supabase
        .from("participantes")
        .select("*")
        .eq("ativo", true);

      const campos = ["lider","anjo","emparedados","batevolta","eliminado"];
      campos.forEach(campo => {
        const select = document.getElementById(campo);
        select.innerHTML = "";
        data.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.nome;
          select.appendChild(opt);
        });
      });
    }

    // Enviar palpites
    const palpitesForm = document.getElementById("palpites-form");
    const palpiteMsg = document.getElementById("palpite-msg");

    palpitesForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const semana = parseInt(document.getElementById("semana").value);
      if (!semana) { alert("Selecione a semana"); return; }

      const campos = ["lider","anjo","emparedados","batevolta","eliminado"];
      let palpites = [];

      campos.forEach(campo => {
        const select = document.getElementById(campo);
        const tipo = campo.toUpperCase();
        let valores = Array.from(select.selectedOptions).map(opt => opt.value);
        if (campo === "lider" || campo === "anjo" || campo === "batevolta") {
          valores = valores.slice(0,1); // só um valor permitido
        }
        valores.forEach(val => {
          palpites.push({
            semana,
            tipo,
            palpiteiro_id: palpiteiroId,
            participante_id: val
          });
        });
      });

      const { data, error } = await supabase.from("palpites").insert(palpites);

      if (error) {
        palpiteMsg.textContent = "Erro ao salvar palpites: " + error.message;
        palpiteMsg.className = "text-red-500";
      } else {
        palpiteMsg.textContent = "Palpites enviados com sucesso!";
        palpiteMsg.className = "text-green-500";
      }
    });
  </script>

</body>
</html>
