<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Grande Irmão - Usuário</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-4xl mx-auto">

  <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Área do Usuário</h1>

  <!-- LOGIN / CADASTRO -->
  <div id="loginDiv" class="bg-white p-8 rounded-2xl shadow-xl max-w-md mx-auto">
    <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">Login / Cadastro</h2>
    <input type="text" id="loginUsuario" placeholder="Nome do usuário" class="border rounded-xl px-4 py-3 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-green-500">
    <input type="date" id="senhaUsuario" placeholder="Data de nascimento" class="border rounded-xl px-4 py-3 w-full mb-4 focus:outline-none focus:ring-2 focus:ring-green-500">
    <button id="btnLoginUsuario" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-xl transition mb-3">Entrar / Registrar</button>
    <p id="msgLoginUsuario" class="mt-3 text-center"></p>
  </div>

  <!-- PALPITES -->
  <div id="palpitesDiv" class="hidden space-y-6">

    <div class="bg-white p-6 rounded-2xl shadow hover:shadow-2xl transition">
      <h2 class="text-xl font-semibold mb-4">Enviar Palpites da Semana</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-medium mb-1">Semana</label>
          <input type="number" id="semanaPalpite" class="border rounded-xl px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        <div>
          <label class="block font-medium mb-1">Líder</label>
          <select id="palpiteLider" multiple class="border rounded-xl px-4 py-2 w-full"></select>
        </div>
        <div>
          <label class="block font-medium mb-1">Anjo</label>
          <select id="palpiteAnjo" multiple class="border rounded-xl px-4 py-2 w-full"></select>
        </div>
        <div>
          <label class="block font-medium mb-1">Emparedados</label>
          <select id="palpiteEmparedados" multiple class="border rounded-xl px-4 py-2 w-full"></select>
        </div>
        <div>
          <label class="block font-medium mb-1">Eliminados</label>
          <select id="palpiteEliminados" multiple class="border rounded-xl px-4 py-2 w-full"></select>
        </div>
        <div>
          <label class="block font-medium mb-1">Bate-Volta</label>
          <select id="palpiteBateVolta" multiple class="border rounded-xl px-4 py-2 w-full"></select>
        </div>
      </div>

      <button id="btnSalvarPalpite" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-xl transition">Enviar Palpites</button>
      <p id="msgPalpite" class="mt-3 text-center font-medium"></p>
    </div>

  </div>

</div>

<script>
const supabaseUrl = "https://biojnilbgzozmynemtra.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb2puaWxiZ3pvem15bmVtdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDM5MzEsImV4cCI6MjA3MjIxOTkzMX0.F8MyL33SdQ7RViOF5RWgoZh8vC6hsyNqmqUXmRcNPDM";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let usuarioLogado = null;

// LOGIN / CADASTRO
document.getElementById("btnLoginUsuario").addEventListener("click", async () => {
  const nome = document.getElementById("loginUsuario").value.trim();
  const dtNascimento = document.getElementById("senhaUsuario").value;
  if(!nome || !dtNascimento){ alert("Preencha os campos"); return; }

  // Tenta encontrar usuário
  let { data, error } = await supabase.from("usuarios").select("*").eq("nome", nome).eq("dt_nascimento", dtNascimento);
  
  if(error){ alert("Erro: " + error.message); return; }

  if(data.length === 0){
    // Cria novo usuário
    const { data: novo, error: err } = await supabase.from("usuarios").insert([{nome, dt_nascimento: dtNascimento}]);
    if(err){ alert("Erro ao registrar: " + err.message); return; }
    usuarioLogado = novo[0];
  } else usuarioLogado = data[0];

  document.getElementById("loginDiv").classList.add("hidden");
  document.getElementById("palpitesDiv").classList.remove("hidden");
  preencherSelects();
});

// CARREGAR PARTICIPANTES
async function carregarParticipantes() {
  const { data, error } = await supabase.from("participantes").select("nome").eq("ativo", true).order("nome");
  if(error){ alert("Erro: " + error.message); return []; }
  return data.map(p => p.nome);
}

// PREENCHER SELECTS
async function preencherSelects() {
  const participantes = await carregarParticipantes();
  ["palpiteLider","palpiteAnjo","palpiteEmparedados","palpiteEliminados","palpiteBateVolta"].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    participantes.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
  });
}

// SALVAR PALPITES
document.getElementById("btnSalvarPalpite").addEventListener("click", async () => {
  const semana = parseInt(document.getElementById("semanaPalpite").value);
  if(!semana){ alert("Informe a semana"); return; }

  const payload = {
    usuario_id: usuarioLogado.id,
    semana,
    lider: Array.from(document.getElementById("palpiteLider").selectedOptions).map(o=>o.value),
    anjo: Array.from(document.getElementById("palpiteAnjo").selectedOptions).map(o=>o.value),
    emparedados: Array.from(document.getElementById("palpiteEmparedados").selectedOptions).map(o=>o.value),
    eliminados: Array.from(document.getElementById("palpiteEliminados").selectedOptions).map(o=>o.value),
    bate_volta: Array.from(document.getElementById("palpiteBateVolta").selectedOptions).map(o=>o.value)
  };

  const { data, error } = await supabase.from("palpites").insert([payload]);
  const msg = document.getElementById("msgPalpite");
  if(error){
    msg.textContent = "Erro: " + error.message;
    msg.className = "mt-3 text-red-600 text-center font-medium";
  } else {
    msg.textContent = "Palpites enviados com sucesso!";
    msg.className = "mt-3 text-green-600 text-center font-medium";
  }
});
</script>
</body>
</html>
