<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Grande Irmão - Palpites</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6 min-h-screen flex items-center justify-center">

<div class="max-w-4xl w-full bg-white p-8 rounded-2xl shadow-xl">

  <h1 class="text-3xl font-bold mb-6 text-center">Grande Irmão - Usuário</h1>

  <!-- CADASTRO / LOGIN -->
  <div id="cadastroDiv" class="mb-6 p-6 bg-gray-50 rounded-xl shadow-inner">
    <h2 class="text-xl font-semibold mb-4">Cadastro ou Login</h2>
    <input type="text" id="usuario" placeholder="Nome" class="border rounded-xl px-4 py-2 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
    <input type="date" id="senha" placeholder="Data de Nascimento" class="border rounded-xl px-4 py-2 w-full mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
    <button id="btnCadastro" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl transition">Cadastrar / Entrar</button>
    <p id="msgCadastro" class="mt-3 text-center font-medium"></p>
  </div>

  <!-- ENVIO DE PALPITES -->
  <div id="palpitesDiv" class="hidden p-6 bg-gray-50 rounded-xl shadow-inner">

    <div class="mb-4">
      <label class="block font-medium mb-1">Semana</label>
      <input type="number" id="semana" class="border rounded-xl px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-green-500">
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block font-medium mb-1">Líder</label>
        <select id="lider" multiple class="border rounded-xl px-4 py-2 w-full"></select>
      </div>
      <div>
        <label class="block font-medium mb-1">Anjo</label>
        <select id="anjo" multiple class="border rounded-xl px-4 py-2 w-full"></select>
      </div>
      <div>
        <label class="block font-medium mb-1">Emparedados</label>
        <select id="emparedados" multiple class="border rounded-xl px-4 py-2 w-full"></select>
      </div>
      <div>
        <label class="block font-medium mb-1">Eliminados</label>
        <select id="eliminados" multiple class="border rounded-xl px-4 py-2 w-full"></select>
      </div>
      <div class="md:col-span-2">
        <label class="block font-medium mb-1">Bate-Volta</label>
        <select id="bateVolta" multiple class="border rounded-xl px-4 py-2 w-full"></select>
      </div>
    </div>

    <button id="enviar" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-xl transition">Enviar Palpites</button>
    <p id="msg" class="mt-3 text-center font-medium"></p>
  </div>

</div>

<script>
const supabaseUrl = "https://biojnilbgzozmynemtra.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpb2puaWxiZ3pvem15bmVtdHJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDM5MzEsImV4cCI6MjA3MjIxOTkzMX0.F8MyL33SdQ7RViOF5RWgoZh8vC6hsyNqmqUXmRcNPDM";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let usuarioAtual = null;

// CADASTRO / LOGIN
document.getElementById("btnCadastro").addEventListener("click", async () => {
  const usuario = document.getElementById("usuario").value.trim();
  const senha = document.getElementById("senha").value;
  if(!usuario || !senha){ 
    alert("Preencha todos os campos"); 
    return; 
  }

  // Verifica se o usuário já existe
  const { data: existente, error: err } = await supabase
    .from("usuarios")
    .select("*")
    .eq("nome", usuario)
    .eq("senha", senha)
    .single();

  if(err && err.code !== 'PGRST116'){ alert("Erro: " + err.message); return; }

  if(existente){
    document.getElementById("msgCadastro").textContent = "Login realizado!";
    document.getElementById("msgCadastro").className = "mt-3 text-green-600 font-medium text-center";
    usuarioAtual = existente;
    document.getElementById("cadastroDiv").classList.add("hidden");
    document.getElementById("palpitesDiv").classList.remove("hidden");
    preencherSelects();
  } else {
    // Cadastra novo usuário
    const { data, error } = await supabase
      .from("usuarios")
      .insert([{ nome: usuario, senha, criado_em: new Date().toISOString() }]);

    if(error){
      document.getElementById("msgCadastro").textContent = "Erro: " + error.message;
      document.getElementById("msgCadastro").className = "mt-3 text-red-600 font-medium text-center";
    } else {
      document.getElementById("msgCadastro").textContent = "Usuário cadastrado!";
      document.getElementById("msgCadastro").className = "mt-3 text-green-600 font-medium text-center";
      usuarioAtual = data[0];
      document.getElementById("cadastroDiv").classList.add("hidden");
      document.getElementById("palpitesDiv").classList.remove("hidden");
      preencherSelects();
    }
  }
});

// CARREGAR PARTICIPANTES ATIVOS
async function preencherSelects() {
  const { data, error } = await supabase
    .from("participantes")
    .select("nome")
    .eq("ativo", true)
    .order("nome");
  if(error){ alert(error.message); return; }

  const participantes = data.map(p => p.nome);
  ["lider","anjo","emparedados","eliminados","bateVolta"].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = "";
    participantes.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
  });
}

// ENVIAR PALPITES
document.getElementById("enviar").addEventListener("click", async () => {
  if(!usuarioAtual){ alert("Usuário não logado"); return; }

  const semana = parseInt(document.getElementById("semana").value);
  if(!semana){ alert("Informe a semana"); return; }

  const payload = {
    usuario: usuarioAtual.nome,
    senha: usuarioAtual.senha,
    semana,
    lider: Array.from(document.getElementById("lider").selectedOptions).map(o=>o.value),
    anjo: Array.from(document.getElementById("anjo").selectedOptions).map(o=>o.value),
    emparedados: Array.from(document.getElementById("emparedados").selectedOptions).map(o=>o.value),
    eliminados: Array.from(document.getElementById("eliminados").selectedOptions).map(o=>o.value),
    bate_volta: Array.from(document.getElementById("bateVolta").selectedOptions).map(o=>o.value),
    criado_em: new Date().toISOString()
  };

  const { data, error } = await supabase
    .from("palpites")
    .insert([payload]);

  const msg = document.getElementById("msg");
  if(error){
    msg.textContent = "Erro ao enviar: " + error.message;
    msg.className = "mt-3 text-red-600 font-medium text-center";
  } else {
    msg.textContent = "Palpite enviado com sucesso!";
    msg.className = "mt-3 text-green-600 font-medium text-center";
    document.getElementById("semana").value = "";
    ["lider","anjo","emparedados","eliminados","bateVolta"].forEach(id => document.getElementById(id).selectedIndex = -1);
  }
});
</script>
</body>
</html>
